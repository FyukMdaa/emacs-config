#+TITLE: init.org
#+AUTHOR: fyukmdaa
#+PROPERTY: header-args:emacs-lisp :tangle yes

* Bootstrap & Core
** Basic Configuration
#+begin_src emacs-lisp
;; 基本設定（early-init.orgと重複しない項目のみ）
(setq create-lockfiles nil
      make-backup-files nil
      auto-save-default nil
      custom-file (concat user-emacs-directory "custom.el"))

(when (file-exists-p custom-file)
  (load custom-file))

;; UI設定
(global-hl-line-mode 1)
(column-number-mode 1)
(global-display-line-numbers-mode 1)
(setq display-line-numbers-type t)

;; スクロールの最適化
(setq scroll-conservatively 101
      scroll-margin 0
      scroll-preserve-screen-position t
      auto-window-vscroll nil)

;; バックアップと自動保存を専用ディレクトリへ（再有効化した場合用）
(let ((backup-dir (concat user-emacs-directory "backups"))
      (auto-save-dir (concat user-emacs-directory "auto-save-list")))
  (unless (file-exists-p backup-dir) (make-directory backup-dir t))
  (unless (file-exists-p auto-save-dir) (make-directory auto-save-dir t))
  (setq backup-directory-alist `((".*" . ,backup-dir))
        auto-save-file-name-transforms `((".*" ,auto-save-dir t))))

;; パッケージの再読み込み防止
(advice-add 'package-refresh-contents :override #'ignore)
;; パッケージのロードをキャッシュ
(setq package-quickstart t)
#+end_src

** History & Persistence
#+begin_src emacs-lisp
(use-package savehist
  :ensure nil
  :demand t
  :config
  (savehist-mode))

(use-package recentf
  :ensure nil
  :demand t
  :config
  (setq recentf-max-saved-items 1000
        recentf-auto-cleanup 'never)
  (recentf-mode 1))
#+end_src

** Performance & Startup
*** Delayed Execution Macro
#+begin_src emacs-lisp
(defvar my/delayed-configurations '())
(defvar my/delayed-timer nil)

(setq my/delayed-timer
      (run-with-timer
       0.3 0.001
       (lambda ()
         (when my/delayed-configurations
           (let ((inhibit-message t))
             (eval (pop my/delayed-configurations))))
         (unless my/delayed-configurations
           (cancel-timer my/delayed-timer)))))

(defmacro with-delayed-execution (&rest body)
  (declare (indent 0))
  `(setq my/delayed-configurations
         (append my/delayed-configurations ',body)))
#+end_src

*** use-package
#+begin_src emacs-lisp
(eval-when-compile
  (require 'use-package))

(eval-and-compile
  (setopt use-package-ensure-function #'ignore) 
  (setopt use-package-always-defer t)
  (setopt use-package-compute-statistics t))
#+end_src

*** twist
#+begin_src emacs-lisp
(use-package twist
  :ensure t
  :hook (emacs-startup . twist-watch-mode))
#+end_src

*** gcmh
#+begin_src emacs-lisp
(use-package gcmh
  :ensure t
  :demand t
  :config
  (gcmh-mode 1))
#+end_src

** Environment Integration
#+begin_src emacs-lisp
(use-package envrc
  :ensure t
  :hook (after-init . envrc-global-mode))

(use-package exec-path-from-shell
  :ensure t
  :if (display-graphic-p)
  :demand t
  :config
  (exec-path-from-shell-initialize))
#+end_src

* User Interface & Appearance
** Themes & Colors
#+begin_src emacs-lisp
(use-package ef-themes
  :ensure t
  :demand t
  :config
  (setq ef-themes-mixed-fonts t
        ef-themes-variable-pitch-ui t
        ef-themes-region '(intense no-extend)
        ef-themes-headings '((1 . (bold 1.3))
                             (2 . (regular 1.2))
                             (t . (regular 1.1))))
  (load-theme 'ef-owl t))
#+end_src

** Layout & Spacing
#+begin_src emacs-lisp
(use-package spacious-padding
  :ensure t
  :demand t
  :config
  (setq spacious-padding-widths
        '(:internal-border-width 15
          :header-line-width 4
          :mode-line-width 6
          :tab-width 4
          :right-divider-width 30
          :scroll-bar-width 8))
  (spacious-padding-mode 1))

;; 列ガイド（prog-modeのみ）
(setq-default display-fill-column-indicator-column 80)
(add-hook 'prog-mode-hook 'display-fill-column-indicator-mode)
#+end_src

** Dashboard
#+begin_src emacs-lisp
(use-package dashboard
  :ensure t
  :demand t
  :init
  (setq initial-buffer-choice (lambda () (get-buffer-create "*dashboard*")))
  :config
  (setq dashboard-banner-logo-title "Welcome to Emacs, fyukmdaa!"
        dashboard-items '((recents . 10)
                         (projects . 5)
                         (bookmarks . 5))
        dashboard-set-heading-icons t
        dashboard-set-file-icons t
        dashboard-icon-type 'nerd-icons
        dashboard-projects-backend 'projectile
        dashboard-center-content t
        dashboard-startup-banner 'logo)
  (dashboard-setup-startup-hook))
#+end_src

** Icons
#+begin_src emacs-lisp
(use-package nerd-icons
  :ensure t
  :demand t)
#+end_src

** Mode Line
#+begin_src emacs-lisp
(use-package moody
  :ensure t
  :demand t
  :config
  (setq x-underline-at-descent-line t)
  (moody-replace-mode-line-buffer-identification)
  (moody-replace-vc-mode))

(use-package minions
  :ensure t
  :demand t
  :config
  (minions-mode 1))

(use-package mlscroll
  :ensure t
  :after moody
  :config
  (setq mlscroll-width-chars 12)
  (mlscroll-mode 1))
#+end_src

** Visual Enhancements (Delayed)
#+begin_src emacs-lisp
(with-delayed-execution
  (use-package dimmer
    :ensure t
    :config
    (setq dimmer-fraction 0.4)
    (dimmer-mode 1)))

(use-package hide-mode-line
  :ensure t
  :hook ((treemacs-mode imenu-list-minor-mode) . hide-mode-line-mode))
#+end_src

* Completion Framework
** Vertico (Completion UI)
#+begin_src emacs-lisp
(use-package vertico
  :ensure t
  :demand t
  :config
  (setq vertico-cycle t
        vertico-resize nil)
  (vertico-mode))

(use-package vertico-posframe
  :ensure t
  :after vertico
  :if (display-graphic-p)
  :config
  (setq vertico-posframe-parameters
        '((left-fringe . 8)
          (right-fringe . 8)))
  (vertico-posframe-mode 1))
#+end_src

** Orderless & Marginalia
#+begin_src emacs-lisp
(use-package orderless
  :ensure t
  :demand t
  :custom
  (completion-styles '(orderless basic))
  (completion-category-overrides '((file (styles basic partial-completion)))))

(use-package marginalia
  :ensure t
  :demand t
  :bind (:map minibuffer-local-map
              ("M-A" . marginalia-cycle))
  :config
  (marginalia-mode))
#+end_src

** Consult (Enhanced Search)
#+begin_src emacs-lisp
(use-package consult
  :ensure t
  :bind (("C-s" . consult-line)
         ("C-x b" . consult-buffer)
         ("C-x 4 b" . consult-buffer-other-window)
         ("C-x r b" . consult-bookmark)
         ("M-g g" . consult-goto-line)
         ("M-g i" . consult-imenu)
         ("M-s d" . consult-find)
         ("M-s g" . consult-grep)
         ("M-s r" . consult-ripgrep))
  :config
  (setq consult-narrow-key "<"
        consult-preview-key 'any))

(use-package consult-dir
  :ensure t
  :bind (("C-x C-d" . consult-dir)
         :map vertico-map
         ("C-x C-d" . consult-dir)
         ("C-x C-j" . consult-dir-jump-file)))
#+end_src

** Embark (Actions)
#+begin_src emacs-lisp
(use-package embark
  :ensure t
  :bind (("C-." . embark-act)
         ("M-." . embark-dwim)
         ("C-h B" . embark-bindings))
  :config
  (setq prefix-help-command #'embark-prefix-help-command))

(use-package embark-consult
  :ensure t
  :after (embark consult)
  :hook (embark-collect-mode . consult-preview-at-point-mode))
#+end_src

** Corfu (In-buffer Completion)
#+begin_src emacs-lisp
(use-package corfu
  :ensure t
  :demand t
  :config
  (setq corfu-auto t
        corfu-auto-delay 0.2
        corfu-auto-prefix 2
        corfu-cycle t
        corfu-preselect 'prompt)
  (global-corfu-mode)
  :bind (:map corfu-map
              ("TAB" . corfu-next)
              ([tab] . corfu-next)
              ("S-TAB" . corfu-previous)
              ([backtab] . corfu-previous)
              ("RET" . corfu-insert)))

(use-package corfu-terminal
  :ensure t
  :if (not (display-graphic-p))
  :after corfu
  :config
  (corfu-terminal-mode +1))

(use-package nerd-icons-corfu
  :ensure t
  :after corfu
  :config
  (add-to-list 'corfu-margin-formatters #'nerd-icons-corfu-formatter))
#+end_src

** Cape & Tempel
#+begin_src emacs-lisp
(use-package cape
  :ensure t
  :init
  (add-to-list 'completion-at-point-functions #'cape-dabbrev)
  (add-to-list 'completion-at-point-functions #'cape-file)
  (add-to-list 'completion-at-point-functions #'cape-keyword))

(use-package tempel
  :ensure t
  :bind (("M-+" . tempel-complete)
         ("M-*" . tempel-insert))
  :init
  (defun my/tempel-setup-capf ()
    (setq-local completion-at-point-functions
                (cons #'tempel-expand
                      completion-at-point-functions)))
  :hook ((prog-mode text-mode) . my/tempel-setup-capf))
#+end_src

** AMX
#+begin_src emacs-lisp
(use-package amx
  :ensure t
  :demand t
  :config
  (amx-mode 1))
#+end_src

* Editing
** Parentheses
#+begin_src emacs-lisp
(use-package paren
  :ensure nil
  :demand t
  :config
  (setq show-paren-delay 0
        show-paren-style 'mixed
        show-paren-when-point-inside-paren t)
  (show-paren-mode 1))

(use-package rainbow-delimiters
  :ensure t
  :hook (prog-mode . rainbow-delimiters-mode))

(use-package puni
  :ensure t
  :hook ((prog-mode sgml-mode nxml-mode tex-mode) . puni-mode)
  :bind (:map puni-mode-map
              ("C-M-f" . puni-forward-sexp)
              ("C-M-b" . puni-backward-sexp)
              ("C-M-t" . puni-transpose)
              ("C-)" . puni-slurp-forward)
              ("C-}" . puni-barf-forward)
              ("C-(" . puni-slurp-backward)
              ("C-{" . puni-barf-backward)))
#+end_src

** Navigation & Selection
#+begin_src emacs-lisp
(use-package avy
  :ensure t
  :bind (("M-j" . avy-goto-char-timer)
         ("M-g f" . avy-goto-line))
  :config
  (setq avy-timeout-seconds 0.3
        avy-all-windows nil))

(use-package expand-region
  :ensure t
  :bind (("C-=" . er/expand-region)
         ("C--" . er/contract-region)))
#+end_src

** Visual Feedback
#+begin_src emacs-lisp
(use-package volatile-highlights
  :ensure t
  :demand t
  :config
  (volatile-highlights-mode 1))

(use-package vundo
  :ensure t
  :bind ("C-x u" . vundo)
  :config
  (setq vundo-glyph-alist vundo-unicode-symbols))
#+end_src

** Search & Replace
#+begin_src emacs-lisp
(use-package anzu
  :ensure t
  :demand t
  :bind (("M-%" . anzu-query-replace)
         ("C-M-%" . anzu-query-replace-regexp))
  :config
  (global-anzu-mode +1))

(use-package visual-regexp
  :ensure t
  :bind (("C-c r" . vr/replace)
         ("C-c q" . vr/query-replace)))

(use-package wgrep
  :ensure t
  :config
  (setq wgrep-auto-save-buffer t))
#+end_src

** Indentation
#+begin_src emacs-lisp
(use-package highlight-indent-guides
  :ensure t
  :hook (prog-mode . highlight-indent-guides-mode)
  :config
  (setq highlight-indent-guides-method 'character
        highlight-indent-guides-responsive 'top
        highlight-indent-guides-delay 0))
#+end_src

* Version Control
** Diff-hl
#+begin_src emacs-lisp
(use-package diff-hl
  :ensure t
  :demand t
  :config
  (global-diff-hl-mode 1)
  (when (fboundp 'diff-hl-flydiff-mode)
    (diff-hl-flydiff-mode 1))
  :hook ((magit-pre-refresh . diff-hl-magit-pre-refresh)
         (magit-post-refresh . diff-hl-magit-post-refresh)
         (dired-mode . diff-hl-dired-mode)))
#+end_src

** Magit
#+begin_src emacs-lisp
(use-package transient
  :ensure t)

(use-package magit
  :ensure t
  :bind ("C-x g" . magit-status)
  :config
  (setq magit-display-buffer-function #'magit-display-buffer-same-window-except-diff-v1))
#+end_src

* Programming & Development
** Tree-sitter
#+begin_src emacs-lisp
(use-package treesit-auto
  :ensure t
  :demand t
  :config
  (setq treesit-auto-install 'prompt)
  (global-treesit-auto-mode))
#+end_src

** LSP & Linting
#+begin_src emacs-lisp
(use-package eglot
  :ensure nil
  :config
  (setq eglot-autoshutdown t
        eglot-sync-connect nil
        eglot-extend-to-xref t))

(use-package consult-eglot
  :ensure t
  :after (consult eglot)
  :bind (:map eglot-mode-map
              ("C-c e s" . consult-eglot-symbols)))

(use-package flycheck
  :ensure t
  :hook (prog-mode . flycheck-mode)
  :config
  (setq flycheck-check-syntax-automatically '(save mode-enabled)))

(use-package consult-flycheck
  :ensure t
  :after (consult flycheck)
  :bind ("C-c ! c" . consult-flycheck))
#+end_src

** Programming Utilities
#+begin_src emacs-lisp
(use-package hl-todo
  :ensure t
  :hook (prog-mode . hl-todo-mode)
  :config
  (setq hl-todo-keyword-faces
        '(("TODO" . "#ff0000")
          ("FIXME" . "#ff9900")
          ("HACK" . "#9900ff")
          ("NOTE" . "#0000ff")
          ("REVIEW" . "#00ff00"))))

(use-package rainbow-mode
  :ensure t
  :hook ((css-mode web-mode) . rainbow-mode))
#+end_src

** Language Support
#+begin_src emacs-lisp
;; Markup & Systems
(use-package markdown-mode
  :ensure t
  :mode (("README\\.md\\'" . gfm-mode)
         ("\\.md\\'" . markdown-mode)
         ("\\.markdown\\'" . markdown-mode))
  :config
  (setq markdown-command "pandoc"))

(use-package nix-ts-mode
  :ensure t
  :mode "\\.nix\\'")

(use-package dockerfile-mode
  :ensure t
  :mode "Dockerfile\\'")

(use-package yaml-mode
  :ensure t
  :mode "\\.ya?ml\\'")

;; Programming Languages
(use-package rust-mode
  :ensure t
  :mode "\\.rs\\'"
  :config
  (setq rust-format-on-save t))

(use-package go-mode
  :ensure t
  :mode "\\.go\\'")

(use-package lua-mode
  :ensure t
  :mode "\\.lua\\'")

;; Web Development
(use-package web-mode
  :ensure t
  :mode ("\\.html?\\'" "\\.erb\\'" "\\.vue\\'" "\\.jsx?\\'")
  :config
  (setq web-mode-markup-indent-offset 2
        web-mode-css-indent-offset 2
        web-mode-code-indent-offset 2
        web-mode-enable-auto-pairing t
        web-mode-enable-css-colorization t))

(use-package emmet-mode
  :ensure t
  :hook ((sgml-mode web-mode css-mode) . emmet-mode))
#+end_src

** Emacs Lisp Development
#+begin_src emacs-lisp
(use-package macrostep
  :ensure t
  :bind (:map emacs-lisp-mode-map
              ("C-c e m" . macrostep-expand)))

(use-package elisp-demos
  :ensure t
  :config
  (advice-add 'helpful-update :after #'elisp-demos-advice-helpful-update))

(use-package highlight-defined
  :ensure t
  :hook (emacs-lisp-mode . highlight-defined-mode))
#+end_src

* Project & File Management
** Projectile
#+begin_src emacs-lisp
(use-package projectile
  :ensure t
  :demand t
  :bind-keymap ("C-c p" . projectile-command-map)
  :config
  (projectile-mode +1)
  (setq projectile-completion-system 'default
        projectile-enable-caching t
        projectile-sort-order 'recently-active
        projectile-indexing-method 'alien))

(use-package consult-projectile
  :ensure t
  :after (projectile consult)
  :bind (:map projectile-command-map
              ("f" . consult-projectile-find-file)
              ("s" . consult-projectile-switch-project)
              ("b" . consult-projectile-switch-to-buffer)))
#+end_src

** Treemacs
#+begin_src emacs-lisp
(use-package treemacs
  :ensure t
  :commands treemacs
  :bind ("C-c t" . treemacs)
  :config
  (setq treemacs-width 30
        treemacs-follow-after-init t
        treemacs-is-never-other-window t)
  (treemacs-follow-mode t)
  (treemacs-filewatch-mode t)
  (treemacs-git-mode 'simple))

(use-package treemacs-nerd-icons
  :ensure t
  :after treemacs
  :config
  (treemacs-load-theme "nerd-icons"))

(use-package treemacs-magit
  :ensure t
  :after (treemacs magit))

(use-package treemacs-projectile
  :ensure t
  :after (treemacs projectile))
#+end_src

** Imenu List & Dired
#+begin_src emacs-lisp
(use-package imenu-list
  :ensure t
  :commands imenu-list-smart-toggle
  :bind ("C-c i" . imenu-list-smart-toggle)
  :config
  (setq imenu-list-focus-after-activation t
        imenu-list-auto-resize t
        imenu-list-position 'right))

(use-package nerd-icons-dired
  :ensure t
  :hook (dired-mode . nerd-icons-dired-mode))

(use-package dired-hide-dotfiles
  :ensure t
  :hook (dired-mode . dired-hide-dotfiles-mode)
  :bind (:map dired-mode-map
              ("H" . dired-hide-dotfiles-mode)))

;; Dired最適化
(use-package dired
  :ensure nil
  :config
  (setq dired-listing-switches "-alh --group-directories-first"
        dired-dwim-target t
        dired-kill-when-opening-new-dired-buffer t))
#+end_src

* Org Mode & Notes
** Org Appearance
#+begin_src emacs-lisp
(use-package org-modern
  :ensure t
  :hook (org-mode . org-modern-mode)
  :config
  (setq org-modern-star 'replace
        org-modern-hide-stars nil
        org-modern-block-name nil
        org-modern-keyword nil
        org-modern-table nil))

(use-package org-appear
  :ensure t
  :hook (org-mode . org-appear-mode)
  :config
  (setq org-appear-autolinks t
        org-appear-autoentities t
        org-appear-autokeywords t
        org-appear-autosubmarkers t
        org-appear-inside-latex t))

(use-package htmlize
  :ensure t)
#+end_src

** Note-taking
#+begin_src emacs-lisp
(use-package denote
  :ensure t
  :commands (denote denote-open-or-create)
  :bind (("C-c n n" . denote)
         ("C-c n f" . denote-open-or-create)
         ("C-c n i" . denote-link))
  :config
  (setq denote-directory (expand-file-name "~/org/notes/")
        denote-known-keywords '("emacs" "nix" "dev" "idea" "work")
        denote-prompts '(title keywords)
        denote-file-type 'org))

(use-package consult-notes
  :ensure t
  :after consult
  :bind ("C-c n s" . consult-notes)
  :config
  (setq consult-notes-denote-files-function #'denote-directory-files))

(use-package olivetti
  :ensure t
  :commands olivetti-mode
  :bind ("C-c o" . olivetti-mode)
  :config
  (setq olivetti-body-width 0.65
        olivetti-minimum-body-width 80))
#+end_src

* Help & Discovery
** Which-key & Helpful
#+begin_src emacs-lisp
(use-package which-key
  :ensure t
  :demand t
  :config
  (setq which-key-idle-delay 0.5
        which-key-popup-type 'side-window
        which-key-side-window-location 'bottom
        which-key-sort-order 'which-key-key-order-alpha)
  (which-key-mode 1))

(use-package helpful
  :ensure t
  :bind (("C-h f" . helpful-callable)
         ("C-h v" . helpful-variable)
         ("C-h k" . helpful-key)
         ("C-h x" . helpful-command)
         ("C-c C-d" . helpful-at-point)))
#+end_src

* Window Management
** Winner Mode & Windmove
#+begin_src emacs-lisp
(winner-mode 1)
(windmove-default-keybindings)
#+end_src

** Hydra
#+begin_src emacs-lisp
(use-package hydra
  :ensure t)

(with-eval-after-load 'hydra
  (defhydra hydra-window (:hint nil)
    "
╔═══════════════════════════════════════════════════╗
║         Window Management Hydra                   ║
╠═══════════════════════════════════════════════════╣
║  Move         Split       Resize      Layout      ║
║  h: ←         v: vert     H: ← shrink  u: undo    ║
║  j: ↓         s: horiz    J: ↓ shrink  r: redo    ║
║  k: ↑         d: delete   K: ↑ grow    b: balance ║
║  l: →         o: delete-o L: → grow    m: max     ║
╚═══════════════════════════════════════════════════╝
"
    ("h" windmove-left)
    ("j" windmove-down)
    ("k" windmove-up)
    ("l" windmove-right)
    ("v" split-window-right)
    ("s" split-window-below)
    ("d" delete-window)
    ("o" delete-other-windows)
    ("H" shrink-window-horizontally)
    ("J" shrink-window)
    ("K" enlarge-window)
    ("L" enlarge-window-horizontally)
    ("u" winner-undo)
    ("r" winner-redo)
    ("b" balance-windows)
    ("m" maximize-window)
    ("q" nil "quit"))

  (global-set-key (kbd "C-c w") 'hydra-window/body))
#+end_src

* Finalization
** GC Settings Restoration
#+begin_src emacs-lisp
(add-hook 'emacs-startup-hook
          (lambda ()
            (setq gc-cons-threshold (* 16 1024 1024)
                  gc-cons-percentage 0.1)
            (setq file-name-handler-alist my--file-name-handler-alist)
            (makunbound 'my--file-name-handler-alist)))
#+end_src

** Startup Message
#+begin_src emacs-lisp
(message "Emacs configuration loaded successfully!")
#+end_src
